---
// SpainMap.astro - Componente simplificado de mapa de Espa√±a con ubicaciones est√°ticas
import "@fontsource-variable/quicksand";
import { spainConfig } from '../mocks/data/spain-locations';
---

<div id="spain-map" class="spain-map-container"></div>

<style>
  .spain-map-container {
    width: 100%;
    height: 100%;
    position: relative;
    background: #1E1E1E;
    overflow: hidden;
  }

  /* Ocultar controles de MapLibre */
  :global(.maplibregl-ctrl-group),
  :global(.maplibregl-ctrl-attrib),
  :global(.maplibregl-ctrl-logo),
  :global(.maplibregl-ctrl) {
    display: none !important;
  }

  /* Pin central de Arteixo */
  :global(.arteixo-central-pin) {
    position: absolute;
    pointer-events: none;
    z-index: 1001;
    transform: translate(-50%, -50%);
    display: flex;
    align-items: center;
    justify-content: center;
  }

  :global(.arteixo-central-pin .pin-content) {
    font-family: 'Quicksand Variable', 'Quicksand', sans-serif;
    font-weight: 700;
    font-size: 13px;
    color: #ffffff;
    text-transform: uppercase;
    letter-spacing: 1px;
    text-shadow: 0 2px 4px rgba(0, 0, 0, 0.8);
    background: linear-gradient(135deg, #5D5D5D, rgba(93, 93, 93, 0.8));
    backdrop-filter: blur(6px);
    padding: 6px 12px;
    border-radius: 12px;
    border: 2px solid rgba(93, 93, 93, 0.4);
    white-space: nowrap;
    box-shadow: 0 4px 16px rgba(93, 93, 93, 0.3);
  }

  /* Pins de centros regionales - estructura simplificada */
  :global(.region-center-pin) {
    position: absolute;
    pointer-events: auto;
    z-index: 1000;
    transform: translateX(-50%);
    display: flex;
    flex-direction: column;
    align-items: center;
    cursor: pointer;
    width: 16px;
    height: 16px;
    border-radius: 50%;
    background: linear-gradient(135deg, #4ade80, #22c55e);
    border: 2px solid rgba(255, 255, 255, 0.8);
    box-shadow:
      0 0 0 4px rgba(74, 222, 128, 0.3),
      0 4px 12px rgba(0, 0, 0, 0.4);
    transition: all 0.3s ease;
  }

  /* Dot del pin (ya no es necesario porque el pin en s√≠ es el dot) */
  :global(.region-center-pin .pin-dot) {
    display: none; /* Ocultamos este elemento ya que usamos el pin directamente */
  }

  :global(.region-center-pin:hover) {
    transform: translateX(-50%) scale(1.2);
    box-shadow:
      0 0 0 8px rgba(74, 222, 128, 0.5),
      0 8px 20px rgba(0, 0, 0, 0.6);
  }

  /* Tooltip simple con latencia - siempre visible */
  :global(.pin-tooltip) {
    position: absolute;
    bottom: 100%;
    left: 50%;
    transform: translateX(-50%);
    margin-bottom: 8px;
    background: linear-gradient(135deg, rgba(0, 0, 0, 0.95), rgba(20, 20, 20, 0.98));
    backdrop-filter: blur(15px);
    color: #4ade80;
    padding: 4px 8px;
    border-radius: 6px;
    font-family: 'Quicksand Variable', 'Quicksand', sans-serif;
    font-weight: 700;
    font-size: 11px;
    white-space: nowrap;
    opacity: 0.8;
    visibility: visible;
    border: 1px solid rgba(74, 222, 128, 0.3);
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.6);
    z-index: 1001;
    transition: all 0.3s ease;
    pointer-events: none;
  }

  :global(.pin-tooltip::after) {
    content: '';
    position: absolute;
    top: 100%;
    left: 50%;
    transform: translateX(-50%);
    border: 5px solid transparent;
    border-top-color: rgba(0, 0, 0, 0.95);
  }

  :global(.region-center-pin:hover .pin-tooltip) {
    background: linear-gradient(135deg, rgba(74, 222, 128, 0.95), rgba(34, 197, 94, 0.98));
    color: #000000;
    border-color: rgba(74, 222, 128, 0.6);
    transform: translateX(-50%) scale(1.1);
  }

  @keyframes pulse-glow {
    0%, 100% {
      opacity: 1;
    }
    50% {
      opacity: 0.7;
    }
  }
</style>

<script>
  import maplibregl from 'maplibre-gl';
  import 'maplibre-gl/dist/maplibre-gl.css';
  import { spainConfig, spainMapData, locationDetails } from '../mocks/data/spain-locations';
  import type { LngLatLike, StyleSpecification, ExpressionSpecification } from 'maplibre-gl';

  let map: maplibregl.Map;
  let markers: maplibregl.Marker[] = [];

  // Configuraci√≥n simplificada del mapa de Espa√±a
  const spainMapConfig = {
    container: 'spain-map',
    style: {
      version: 8,
      sources: {
        'countries': {
          type: 'vector',
          tiles: [
            'https://demotiles.maplibre.org/tiles/{z}/{x}/{y}.pbf'
          ],
          minzoom: 0,
          maxzoom: 14
        }
      },
      layers: [
        {
          id: 'background',
          type: 'background',
          paint: {
            'background-color': '#1a1a1a'
          }
        },
        {
          id: 'countries-base',
          type: 'fill',
          source: 'countries',
          'source-layer': 'countries',
          paint: {
            'fill-color': '#2A2A2A',
            'fill-opacity': 0.8,
            'fill-outline-color': 'rgba(0,0,0,0)',
            'fill-antialias': false
          }
        }
      ]
    } as StyleSpecification,
    center: spainMapData.center as LngLatLike,
    zoom: spainMapData.zoom.initial,
    minZoom: spainMapData.zoom.min,
    maxZoom: spainMapData.zoom.max,
    pitch: 0,
    bearing: 0,
    interactive: false, // Mapa est√°tico
    scrollZoom: false,
    boxZoom: false,
    dragRotate: false,
    dragPan: false,
    keyboard: false,
    doubleClickZoom: false,
    touchZoomRotate: false,
    preserveDrawingBuffer: true,
    antialias: true
  };

  function initializeSpainMap() {
    try {
      map = new maplibregl.Map(spainMapConfig);

      map.on('load', () => {
        console.log('üá™üá∏ Mapa est√°tico de Espa√±a cargado');

        // Colorear Espa√±a
        addSpainColors();

        // Crear pins de todas las ubicaciones
        createAllLocationPins();
      });

      map.on('error', (e) => {
        console.error('Error en el mapa de Espa√±a:', e);
        setTimeout(() => {
          if (!map.loaded()) {
            initializeSpainMap();
          }
        }, 2000);
      });

      return map;
    } catch (error) {
      console.error('Error inicializando el mapa de Espa√±a:', error);
      setTimeout(initializeSpainMap, 2000);
    }
  }

  function addSpainColors() {
    // Destacar Espa√±a en color gris, resto del mapa en gris m√°s oscuro
    const expression: ExpressionSpecification = [
      'case',
      ['==', ['get', 'NAME'], 'Spain'], '#5D5D5D',
      ['==', ['get', 'name'], 'Spain'], '#5D5D5D',
      ['==', ['get', 'iso_a2'], 'ES'], '#5D5D5D',
      '#2A2A2A'
    ];

    try {
      map.addLayer({
        id: 'spain-highlighted',
        type: 'fill',
        source: 'countries',
        'source-layer': 'countries',
        paint: {
          'fill-color': expression,
          'fill-opacity': 0.8,
          'fill-outline-color': 'transparent'
        }
      });
      console.log('‚úÖ Espa√±a destacada en el mapa');
    } catch (error) {
      console.error('‚ùå Error destacando Espa√±a:', error);
    }
  }

  function createAllLocationPins() {
    console.log('üìç Creando pins para todas las ubicaciones...');

    // Crear pin central de Arteixo
    createCentralPin();

    // Crear pins para todas las ubicaciones remotas como region-center-pin
    spainConfig.remoteNodes.forEach((node) => {
      createRegionCenterPin(node);
    });
  }

  function createCentralPin() {
    const centralNode = spainConfig.centralNode;
    console.log('üè¢ Creando pin central de Arteixo:', centralNode.coordinates);

    if (!centralNode.coordinates || centralNode.coordinates.length !== 2) {
      console.error('‚ùå Coordenadas de Arteixo inv√°lidas:', centralNode.coordinates);
      return;
    }

    const centralContainer = document.createElement('div');
    centralContainer.className = 'arteixo-central-pin';
    centralContainer.innerHTML = `
      <span class="pin-content">${centralNode.name}</span>
    `;

    const marker = new maplibregl.Marker({
      element: centralContainer,
      anchor: 'center'
    })
    .setLngLat(centralNode.coordinates)
    .addTo(map);

    markers.push(marker);
    console.log('‚úÖ Pin central de Arteixo creado');
  }

  function createRegionCenterPin(node: any) {
    console.log(`üìç Creando region-center-pin para ${node.name}`);

    if (!node.coordinates || node.coordinates.length !== 2) {
      console.error(`‚ùå Coordenadas inv√°lidas para ${node.name}:`, node.coordinates);
      return;
    }

    const pin = document.createElement('div');
    pin.className = 'region-center-pin';

    // Obtener latencia del nodo o generar una aleatoria
    const latency = node.latency || Math.floor(Math.random() * 50) + 10;

    pin.innerHTML = `
      <div class="pin-dot"></div>
      <div class="pin-tooltip">${latency}ms</div>
    `;

    try {
      const marker = new maplibregl.Marker({
        element: pin,
        anchor: 'bottom'
      })
      .setLngLat(node.coordinates)
      .addTo(map);

      markers.push(marker);
      console.log(`‚úÖ Region-center-pin creado para ${node.name} con latencia ${latency}ms`);
    } catch (error) {
      console.error(`‚ùå Error creando region-center-pin para ${node.name}:`, error);
    }
  }

  // Funci√≥n para obtener estad√≠sticas b√°sicas del mapa
  function getSpainMapStats() {
    return {
      totalLocations: spainConfig.remoteNodes.length + 1, // +1 por Arteixo
      markersCount: markers.length,
      mapLoaded: map ? map.loaded() : false,
      isStatic: true
    };
  }

  // Inicializar cuando el DOM est√© listo
  document.addEventListener('DOMContentLoaded', initializeSpainMap);

  // Funciones globales para debugging
  (window as any).spainMapUtils = {
    getSpainConfig: () => spainConfig,
    getMap: () => map,
    getStats: getSpainMapStats,
    markers: () => markers,
    debugSpainMap: () => {
      console.log('=== DEBUG SPAIN MAP (STATIC) ===');
      console.log('Map loaded:', map ? map.loaded() : 'Not initialized');
      console.log('Total markers:', markers.length);
      console.log('Spain config locations:', spainConfig.remoteNodes.length);
      console.log('Central node:', spainConfig.centralNode);
    },
    locationDetails: locationDetails
  };
</script>
