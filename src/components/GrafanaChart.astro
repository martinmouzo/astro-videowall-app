---
// Define las propiedades que acepta el componente
export interface Props {
  /** ID único de la gráfica de Grafana */
  graphId: string;
  /** Tiempo de inicio para el rango de la gráfica (ej: 'end-30m', 'now-1h') */
  startTime?: string;
  /** Tiempo final para el rango de la gráfica (ej: 'now') */
  endTime?: string;
  /** Intervalo en milisegundos para actualizar la gráfica (0 para desactivar) */
  refreshInterval?: number;
  /** Altura del contenedor (CSS value) */
  height?: string;
  /** URL de un logo para mostrar (opcional) */
  logoUrl?: string;
  /** Altura máxima del logo (CSS value) */
  logoHeight?: string;
  /** Texto a mostrar durante la carga */
  loadingText?: string;
  /** ID único para el componente (opcional, se genera automáticamente) */
  uniqueId?: string;
  /** Parámetros adicionales para la URL de Grafana */
  extraParams?: Record<string, string>;
}

// Establece valores predeterminados para props opcionales
const {
  graphId,
  startTime = "end-30m",
  endTime = "now",
  refreshInterval = 60000,
  height = "500px",
  logoUrl = "",
  logoHeight = "50px",
  loadingText = "Cargando...",
  uniqueId = `grafana-${Math.random().toString(36).substring(2, 11)}`,
  extraParams = {},
} = Astro.props;

// IDs únicos para los elementos DOM
const containerId = `container-${uniqueId}`;
const iframeId = `iframe-${uniqueId}`;
const loadingId = `loading-${uniqueId}`;
---

<div class="iframe-container" id={containerId} style={`height: ${height};`}>
  {logoUrl && logoHeight !== "0px" && <img src={logoUrl} class="logo" alt="Logo" />}
  <iframe
    id={iframeId}
    style="display: none; width: 100%; height: 100%; border: none; margin: 0; padding: 0; background-color: transparent;"
    frameborder="0"
    scrolling="no" /* Evitar barras de scroll en el iframe */
  ></iframe>
  <div id={loadingId} class="loading">
    {loadingText}
  </div>
</div>

<script
  define:vars={{
    containerId,
    iframeId,
    loadingId,
    graphId,
    startTime,
    endTime,
    refreshInterval,
    extraParams,
    // No es necesario pasar height aquí si se usa en style del div
  }}
>
  const containerElement = document.getElementById(containerId);
  const iframeElement = document.getElementById(iframeId);
  const loadingElement = document.getElementById(loadingId);
  let intervalId = undefined;

  const updateIframeUrl = () => {
    if (containerElement && iframeElement && loadingElement) {
      const actualWidth = containerElement.offsetWidth;
      const actualHeight = containerElement.offsetHeight;

      if (actualWidth === 0 || actualHeight === 0) {
        setTimeout(updateIframeUrl, 100); // Reintentar si el contenedor no tiene dimensiones
        return;
      }

      const params = new URLSearchParams({
        Graph: graphId,
        Start: startTime,
        End: endTime,
        Width: Math.floor(actualWidth).toString(),
        Height: Math.floor(actualHeight).toString(),
        _: new Date().getTime().toString(), // Cache buster
      });

      for (const [key, value] of Object.entries(extraParams)) {
        params.append(key, value);
      }

      const newIframeUrl = `/api/grafana-proxy?${params.toString()}`;

      if (iframeElement.src !== newIframeUrl) {
        loadingElement.style.display = "flex";
        iframeElement.style.display = "none";
        iframeElement.src = newIframeUrl;
      }

      iframeElement.onload = () => {
        setTimeout(() => { // Pequeño delay para asegurar renderizado completo
          loadingElement.style.display = "none";
          iframeElement.style.display = "block";
        }, 200);
      };

      iframeElement.onerror = () => {
        loadingElement.innerHTML = "Error al cargar el gráfico";
        console.error(`Error cargando gráfico ${graphId}`);
      };
    } else {
      console.error("GrafanaChart: Elementos DOM no encontrados.");
    }
  };

  let resizeObserver;

  function initialize() {
    updateIframeUrl();

    if (refreshInterval > 0) {
      intervalId = window.setInterval(updateIframeUrl, refreshInterval);
    }

    // Observar cambios de tamaño del contenedor para ajustar el iframe
    if (containerElement) {
      resizeObserver = new ResizeObserver(() => {
        // Solo actualizar si las dimensiones son válidas y han cambiado significativamente
        // Esto es opcional y para evitar bucles de resize si el contenido del iframe causa resize
        const currentWidth = containerElement.offsetWidth;
        const currentHeight = containerElement.offsetHeight;
        if (currentWidth > 0 && currentHeight > 0) {
            // Podrías añadir una comprobación para ver si las dimensiones han cambiado realmente
            // antes de llamar a updateIframeUrl para evitar llamadas innecesarias.
            updateIframeUrl();
        }
      });
      resizeObserver.observe(containerElement);
    }
  }

  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", initialize);
  } else {
    initialize();
  }

  const cleanup = () => {
    if (intervalId) {
      clearInterval(intervalId);
      intervalId = undefined;
    }
    if (resizeObserver && containerElement) {
      resizeObserver.unobserve(containerElement);
    }
  };

  window.addEventListener("beforeunload", cleanup);
  // Astro específico: limpiar en transiciones de página del lado del cliente
  document.addEventListener("astro:before-swap", cleanup);
  // Considerar también astro:page-load si es necesario re-inicializar en ciertas navegaciones
</script>

<style define:vars={{ logoHeight }}> /* Quitar height de define:vars si se maneja inline */
  .iframe-container {
    width: 100%;
    /* height: var(--height); Ya no se usa así si es inline style */
    background-color: transparent; /* Hacer transparente para que tome el de Panel2 */
    position: relative;
    overflow: hidden; /* Muy importante para evitar scrollbars */
    box-sizing: border-box;
  }

  .loading {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #ccc;
    background-color: rgba(30, 30, 30, 0.8); /* Fondo de carga semi-transparente */
    font-size: 0.9em;
    z-index: 1;
  }

  .logo {
    position: absolute;
    max-width: 90%; /* O ajusta según necesidad */
    max-height: var(--logoHeight);
    object-fit: contain;
    z-index: 10;
    top: 8px;
    left: 8px;
    /* display gestionado en el template con logoHeight !== "0px" */
  }
</style>
