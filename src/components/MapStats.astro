---
// MapStats.astro - Componente para mostrar estadísticas del mapa en tiempo real
---

<div id="map-stats" class="map-stats-container">
  <div class="stats-header">
    <h3>Network Monitor</h3>
    <div class="status-indicator online"></div>
  </div>

  <div class="stats-grid">
    <div class="stat-item">
      <div class="stat-value" id="total-nodes">-</div>
      <div class="stat-label">Total Nodes</div>
    </div>

    <div class="stat-item">
      <div class="stat-value" id="active-connections">-</div>
      <div class="stat-label">Active Connections</div>
    </div>

    <div class="stat-item">
      <div class="stat-value" id="avg-latency">-</div>
      <div class="stat-label">Avg Latency (ms)</div>
    </div>

    <div class="stat-item">
      <div class="stat-value" id="map-status">-</div>
      <div class="stat-label">Map Status</div>
    </div>
  </div>

  <div class="last-update">
    Last Update: <span id="last-update-time">-</span>
  </div>
</div>

<style>
  .map-stats-container {
    position: absolute;
    top: 20px;
    right: 20px;
    background: rgba(0, 0, 0, 0.8);
    border-radius: 12px;
    padding: 20px;
    color: white;
    font-family: 'Arial', sans-serif;
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.1);
    min-width: 280px;
    z-index: 1000;
  }

  .stats-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 15px;
    padding-bottom: 10px;
    border-bottom: 1px solid rgba(255, 255, 255, 0.2);
  }

  .stats-header h3 {
    margin: 0;
    font-size: 18px;
    font-weight: bold;
    color: #FFD700;
  }

  .status-indicator {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    background: #2DB34A;
    box-shadow: 0 0 10px rgba(45, 179, 74, 0.6);
    animation: pulse-indicator 2s ease-in-out infinite;
  }

  .status-indicator.offline {
    background: #FF3B30;
    box-shadow: 0 0 10px rgba(255, 59, 48, 0.6);
  }

  .stats-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 15px;
    margin-bottom: 15px;
  }

  .stat-item {
    text-align: center;
    background: rgba(255, 255, 255, 0.05);
    border-radius: 8px;
    padding: 12px;
    border: 1px solid rgba(255, 255, 255, 0.1);
  }

  .stat-value {
    font-size: 24px;
    font-weight: bold;
    color: #2DB34A;
    margin-bottom: 5px;
    transition: all 0.3s ease;
  }

  .stat-value.warning {
    color: #FF9500;
  }

  .stat-value.critical {
    color: #FF3B30;
  }

  .stat-label {
    font-size: 12px;
    color: rgba(255, 255, 255, 0.7);
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .last-update {
    font-size: 12px;
    color: rgba(255, 255, 255, 0.6);
    text-align: center;
    padding-top: 10px;
    border-top: 1px solid rgba(255, 255, 255, 0.1);
  }

  @keyframes pulse-indicator {
    0%, 100% {
      opacity: 1;
      transform: scale(1);
    }
    50% {
      opacity: 0.7;
      transform: scale(1.1);
    }
  }

  /* Responsive */
  @media (max-width: 768px) {
    .map-stats-container {
      top: 10px;
      right: 10px;
      min-width: 250px;
      padding: 15px;
    }

    .stats-grid {
      gap: 10px;
    }

    .stat-value {
      font-size: 20px;
    }
  }
</style>

<script>
  let statsUpdateInterval: number;

  function updateMapStats() {
    // Verificar si las funciones del mapa están disponibles
    if (typeof (window as any).mapUtils === 'undefined') {
      return;
    }

    try {
      const stats = (window as any).mapUtils.getMapStats();

      // Actualizar valores
      document.getElementById('total-nodes')!.textContent = stats.totalNodes.toString();
      document.getElementById('active-connections')!.textContent = stats.activeConnections.toString();

      const avgLatencyElement = document.getElementById('avg-latency')!;
      avgLatencyElement.textContent = stats.averageLatency.toString();

      // Cambiar color basado en latencia promedio
      avgLatencyElement.className = 'stat-value';
      if (stats.averageLatency > 200) {
        avgLatencyElement.classList.add('critical');
      } else if (stats.averageLatency > 100) {
        avgLatencyElement.classList.add('warning');
      }

      const mapStatusElement = document.getElementById('map-status')!;
      mapStatusElement.textContent = stats.mapLoaded ? 'ONLINE' : 'LOADING';
      mapStatusElement.className = 'stat-value';
      if (!stats.mapLoaded) {
        mapStatusElement.classList.add('warning');
      }

      // Actualizar indicador de estado
      const statusIndicator = document.querySelector('.status-indicator');
      if (statusIndicator) {
        if (stats.mapLoaded && stats.activeConnections > 0) {
          statusIndicator.classList.remove('offline');
        } else {
          statusIndicator.classList.add('offline');
        }
      }

      // Actualizar timestamp
      const now = new Date();
      document.getElementById('last-update-time')!.textContent =
        now.toLocaleTimeString('es-ES', {
          hour: '2-digit',
          minute: '2-digit',
          second: '2-digit'
        });

    } catch (error) {
      console.error('Error actualizando estadísticas del mapa:', error);
    }
  }

  function startStatsUpdates() {
    // Actualizar inmediatamente
    updateMapStats();

    // Continuar actualizando cada 5 segundos
    statsUpdateInterval = window.setInterval(updateMapStats, 5000);
  }

  function stopStatsUpdates() {
    if (statsUpdateInterval) {
      clearInterval(statsUpdateInterval);
    }
  }

  // Inicializar cuando el DOM esté listo
  document.addEventListener('DOMContentLoaded', () => {
    // Esperar un poco para que el mapa se inicialice
    setTimeout(startStatsUpdates, 1000);
  });

  // Limpiar interval al salir de la página
  window.addEventListener('beforeunload', stopStatsUpdates);

  // Exponer funciones globalmente para debugging
  (window as any).mapStatsUtils = {
    updateMapStats,
    startStatsUpdates,
    stopStatsUpdates
  };
</script>
